<% content_for :page_title, t(:page_titles, "Assessments") %>

<% if @context.feature_enabled?(:draft_state) %>

    <% jammit_css :quizzes %>
    <% js_bundle :quizzes_index %>

    <%
       @body_classes << 'with_item_groups'

       js_env(:QUIZZES => {
               :assignment => @assignment_json,
               :open       => @open_json,
               :surveys    => @surveys_json,
               :options    => @quiz_options
       },
              :URLS => {
                      :new_quiz_url       => context_url(@context, :new_context_quiz_url, :fresh => 1),
                      :question_banks_url => context_url(@context, :context_question_banks_url)
              },
              :PERMISSIONS => {
                      :create  => can_do(@context.quizzes.new, @current_user, :create),
                      :manage  => can_do(@context, @current_user, :manage_assignments)
              },
              :FLAGS => {
                      :question_banks => feature_enabled?(:question_banks)
              })
    %>
<% else %>
    <% js_bundle :quizzes_index_legacy  %>

    <% content_for :right_side do %>
        <% if can_do(@context.quizzes.new, @current_user, :create) %>
            <div class="rs-margin-lr rs-margin-top">
              <%
                 # Create New Quiz title
                 cnq_title = t('links.create_new_quiz', "Create a New Assessment")
              %>
              <a href="<%= context_url(@context, :new_context_quiz_url, :fresh => 1) %>" class="btn button-sidebar-wide new-quiz-link"><i class="icon-add"><span class="screenreader-only"><%= cnq_title %></span></i> <%= cnq_title %></a>
              <% if can_do(@context, @current_user, :manage_assignments) && feature_enabled?(:question_banks) %>
                  <%
                     # Manage Question Banks title
                     mqb_title = t('links.manage_question_banks', "Manage Question Banks")
                  %>
                  <a href="<%= context_url(@context, :context_question_banks_url) %>" class="btn button-sidebar-wide"><i class="icon-question"><span class="screenreader-only"><%= mqb_title %></span></i> <%= mqb_title %></a>
              <% end %>

            </div>
        <% end %>
    <% end %>
    <% content_for :stylesheets do %>
        <style>
            ul.quiz_list {
                margin-top: 5px;
                padding-left: 10px;
            }
            ul.quiz_list li.quiz {
                list-style-type: none;
                display: block;
                margin-bottom: 5px;
                padding: 5px;
                border: 1px solid #ccc;
            }
            ul.quiz_list li.quiz.unpublished {
                border-width: 2px;
            }
            ul.quiz_list li.quiz div.title {
                font-size: 1.2em;
                font-weight: bold;
            }
            ul.quiz_list li.quiz div.description {
                font-size: 0.85em;
                margin-left: 20px;
            }
        </style>
    <% end %>
    <% if can_do(@context, @current_user, :manage_assignments) && @unpublished_quizzes && !@unpublished_quizzes.empty? %>
        <h2><%= t('headers.unpublished_quizzes', "Unpublished Assessments") %></h2>
        <ul class="quiz_list" id="unpublished_quizzes">
          <%= render :partial => "quiz_summary", :collection => @unpublished_quizzes, :locals => {:unpublished => true} %>
        </ul>
        <div title="<%= t('headers.publish_multiple_quizzes', "Publish Multiple Assessments") %>" id="publish_multiple_quizzes_dialog" style="display: none;">
          <%= form_tag context_url(@context, :context_quizzes_publish_url), :id => "publish_quizzes_form" do %>
              <%= before_label(:publish_multiple_quizzes, "Select the assessments you would like to publish at this time") %>
              <ul class="quiz_list unstyled_list">
                <li class="quiz_item blank" style="display: none;">
                  <input type="checkbox" value="1" name="quizzes[]" class="id"/>
                  <label class="title">&nbsp;</label>
                </li>
              </ul>
              <div class="button-container">
                <button type="submit" class="btn submit_button"><%= t('buttons.publish_quizzes', "Publish Assessments") %></button>
                <button type="button" class="btn btn button-secondary cancel_button"><%= t('#buttons.cancel', "Cancel") %></button>
              </div>
          <% end %>
        </div>
    <% end %>

        <h2><%= t('headers.assignment_quizzes', "Assignment Assessments") %></h2>
        <ul class="quiz_list">
          <li class="quiz clearfix <%= 'unpublished' if unpublished %>" id="summary_quiz_<%= q ? q.id : "blank" %>" style="position: relative">
            <div class="title">
              <a href="<%= context_url(@context, :context_quiz_url, q) %>" class="quiz_title"><%= q.quiz_title || q.readable_type %></a>
              <span class="quiz_id" style="display: none;"><%= (q && q.id) || nbsp %></span>
              <% if q && q.assignment_id && q.assignment.try(:points_possible) %>
                  <span style="font-size: 0.8em; font-weight: normal;">(<%= t(:assignment_points_possible, "pt", :count => q.assignment.points_possible) %>)</span>
              <% end %>
            </div>

            <% if q.available? %>
                <div style="border-bottom: 1px solid #ccc;float: right;">
                  <a href="<%= course_quiz_invitations_path(@context,q) %>" class="send_invitation" data-id="<%= q.id %>" data-course-id="<%= @context.id %>">
                    <i class="icon-invitation"><span class="screenreader-only"><%= "Send Invitations" %></span></i> <%= "Send Invitations" %>
                  </a>
                </div>
                <br/>
            <% end %>
            <div class="description user_content">
              <% if q.available? %>
                  <div style="float: right; margin: 0 0 0 20px;">

                    <div style="float: right; margin: 0 0 0 20px;">
                      <% if submission %>
                          <%= before_label(:latest_submission, "Latest Submission") %>
                      <% elsif q.survey? %>
                          <%= before_label(:survey_details, "Survey Details") %>
                      <% else %>
                          <%= before_label(:quiz_details, "Assesments Details") %>
                      <% end %>
                    </div>

                    <% if submission && submission.completed? %>
                        <%= datetime_string(submission.finished_at) %><br/>
                        <% if q.muted? %>
                            <%= t(:points_possible, "%{points_possible} points possible", :points_possible => q.points_possible) %><br />
                            <%= image_tag "sound_mute.png", :alt => t("#gradebooks.grade.muted", "Muted"), :class => "muted_icon" %>
                            <%= t(:student_mute_notification, "Instructor is working on grades") %>
                        <% else %>
                            <% unless q.ungraded? %>
                                <%= score_out_of_points_possible(submission.score, q.points_possible) %>
                            <% end %>
                        <% end %>
                    <% elsif submission %>
                        <%= datetime_string(submission.started_at) %><br/>
                        <% if q.cant_go_back? %>
                            <%= link_to(resume_poll_message(q), polymorphic_url([@context, q])) %>
                        <% elsif !q.locked? %>
                            <%= link_to(resume_poll_message(q), context_url(@context, :context_quiz_take_url, q.id, :user_id => @current_user && @current_user.id), :method => :post) %>
                        <% end %>
                    <% else %>
                        <% unless q.ungraded? %>
                            <%= q.points_possible ? t(:quiz_points_possible, "Point", :count => q.points_possible) : t(:quiz_no_points, "No Points") %><br/>
                        <% end %>
                        <%= t(:question_count, "Question", :count => q.question_count) %>
                    <% end %>
                  </div>
                  <% if q.multiple_due_dates_apply_to?(@current_user) %>
                      <%= before_label(:quiz_due, "Due") %>
                      <%= multiple_due_date_tooltip(q, @currentuser,
                                                    :text => t(:quiz_multiple_due_dates, "Multiple Dates"),
                                                    :href => context_url(@context, :context_quiz_url, q)) %>
                      <br/>
                  <% elsif due_at = q.overridden_for(@current_user).due_at %>
                      <%= before_label(:quiz_due, "Due") %> <%= datetime_string(due_at) %><br/>
                  <% end %>
                  <% if q.time_limit %>
                      <%= before_label(:quiz_time_limit, "Time Limit") %> <%= duration_in_minutes(q.time_limit.minutes) %><br/>
                  <% end %>
                  <% if q.allowed_attempts && q.allowed_attempts != 1 %>
                      <% if q.allowed_attempts > 0 %>
                          <%= before_label(:allowed_attempts, "Allowed Attempts") %> <%= q.allowed_attempts %><br/>
                          <% if submission %>
                              <%= before_label(:attempts_left, "Attempts Left") %> <%= q.allowed_attempts - submission.attempt %><br/>
                          <% end %>
                      <% else %>
                          <%= t(:unlimited_attempts, "Unlimited Attempts") %><br/>
                          <% if submission %>
                              <%= before_label(:attempts_so_far, "Attempts So Far") %> <%= submission.attempt %><br/>
                          <% end %>
                      <% end %>
                  <% end %>
              <% else %>
                  <%= t(:question_count, "Question", :count => q.unpublished_question_count) %>
              <% end %>
              <div class="user_content" style="margin-top: 5px;">
                <%= user_content(truncate_html(q.description || t(:no_details, "No Details"), :num_words => 50)) %>
              </div>
              <div class="clear"></div>
            </div>

            <% if can_do(q, @current_user, :update) %>
                <div class="quiz_actions" style="position: absolute; top: 5px; right: 5px; font-weight: normal;">
                  <div>
                    <a href="<%= context_url(@context, :edit_context_quiz_url, q) %>" title="<%= quiz_edit_text(q) %>" class="edit_quiz_link no-hover icon-edit standalone-icon">
                      <span class="screenreader-only"><%= quiz_edit_text(q) %></span>
                    </a>
                    <a href="<%= context_url(@context, :context_quiz_url, q) %>" title="<%= quiz_delete_text(q) %>" class="delete_quiz_link no-hover icon-trash standalone-icon">
                      <span class="screenreader-only"><%= quiz_delete_text(q) %></span>
                    </a>
                  </div>
                </div>
            <% end %>
          </li>

        </ul>




    <div id="send_invitations">

    </div>
<% end %>